# Task PBI-02-02: Secure External Retrievals + Env Toggles

- Parent PBI: [PBI-02](./prd.md)
- Type: code
- Status: Done

## Title
Harden analyze-engine external retrievals with server-side secrets, env toggles, and timeout; update docs.

## Description
Add environment-gated external retrievals to `analyze-engine` using a server-side Perplexity key only. Introduce `EDGE_ENABLE_RETRIEVALS` and `EDGE_RETRIEVAL_TIMEOUT_MS` to control usage and latency. Update docs to instruct using Supabase Functions secrets. Ensure client `.env` contains only public Vite vars.

## Files
- `supabase/functions/analyze-engine/index.ts`
- `README.md`
- `docs/delivery/PBI-02/tasks.md`
- `docs/delivery/PBI-02/test_evidence.md`

## Test Plan
1) Disabled by default
- Ensure no `EDGE_ENABLE_RETRIEVALS` is set (or set to `false`).
- Call analyze-engine with a prompt; expect `analysis.retrievals.length == 0` and `analysis.provenance.evidence_backed == false` and `warning` indicating retrieval disabled.

2) Enabled with key
- Set secrets: `EDGE_ENABLE_RETRIEVALS=true`, `EDGE_PERPLEXITY_API_KEY=<key>`.
- Deploy function and call analyze-engine; expect `retrievals.length >= 1` (when citations returned), `evidence_backed` true, no errors.

3) Timeout path
- Set `EDGE_RETRIEVAL_TIMEOUT_MS=1` and keep `EDGE_ENABLE_RETRIEVALS=true`.
- Call analyze-engine; expect `retrievals.length == 0`, `evidence_backed == false`, `provenance.warning` mentions timeout or retrieval exception; function returns 200.

4) Regression
- Verify system-status and health still return OK and shapes are unchanged for UI.

## Status History
- 2025-08-26T20:32:00+05:30 | Created | InProgress | AI_Agent
- 2025-08-26T21:05:00+05:30 | Submitted | Review | Tests executed and evidence attached; defaults restored
- 2025-08-26T21:10:12+05:30 | Approved | Done | UI empty-state verified; deployment stable; secrets restored
